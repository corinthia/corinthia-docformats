<!doctype html>
<html lang="en" ng-app="corApp">

<head>
    <meta charset="utf-8">
    <title>Corinthia Node</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.1.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="css/app.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.4.9/angular.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.4.9/angular-route.min.js"></script>
    <script src="js/app.js"></script>
    <script src="js/controllers.js"></script>
    <script src="js/controllers/CorMode.js"></script>
    <script src="js/controllers/CorInput.js"></script>
    <script src="js/controllers/CorEdit.js"></script>
    <script src="js/controllers/DFNodeTable.js"></script>
    <script src="js/components/d3/d3.js/d3.controllers.js"></script>
    <script src="js/components/d3/d3.js/d3-tip.js"></script>
    <script>
        "use strict"; //TODO - export to its own js file

        var api;

        function start(theAPI) {
            api = theAPI;
            console.log("in start");
            api.main.init(768, 100, null);
            api.cursor.moveToStartOfDocument();
        }

        function contentLoaded() {
            console.log("Content loaded");

            var iframe = document.getElementById("editFrame");
            var requireScript = iframe.contentDocument.createElement("script");
            requireScript.src = "require.js";
            requireScript.setAttribute("src", "../../js/require.js");
            requireScript.setAttribute("data-main", "../../js/iframe-code");
            requireScript.addEventListener("load", function() {
                console.log("require.js loaded in content iframe");
                iframe.contentWindow.require(["editor/externalapi"], function(api) {
                    console.log("** here");
                    start(api);
                });
            });
            iframe.contentDocument.body.appendChild(requireScript);
        }

        function cleanup() {
            console.log("remove scripts");
            var iframe = document.getElementById("editFrame");
            //only one of these but ...
            var bodyscripts = iframe.contentDocument.body.getElementsByTagName("script");
            if(bodyscripts.length > 1)
                console.log("More than one script in the body");
            else {
                iframe.contentDocument.body.removeChild(bodyscripts[0])
            }
            var headscripts = iframe.contentDocument.head.getElementsByTagName("script");
            console.log("number of headscripts " + headscripts.length);
            while(headscripts.length > 0) {
                iframe.contentDocument.head.removeChild(headscripts[0]);
            }
            //We added viewport metadata
            var metas = iframe.contentDocument.head.getElementsByTagName("meta");
            var removedCount = 0;
            var ndx = 0;
            while(ndx < metas.length && removedCount < 2) {
                if(metas[ndx].hasAttribute("name")) {
                    if(metas[ndx].getAttribute("name").toLowerCase() == "viewport") {
                        iframe.contentDocument.head.removeChild(metas[ndx]);
                        //don't increment the ndx if removed because length changes
                    } else {
                        ndx++;
                    };
                } else {
                    ndx++;
                }
            }
        }
    </script>

    <body>
        <div ng-view></div>
    </body>

</html>
